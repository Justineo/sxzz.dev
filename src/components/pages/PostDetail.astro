---
import { render, type CollectionEntry } from 'astro:content'
import { getPageCopy } from '../../i18n/pages'
import {
  getLocaleFromLang,
  useTranslatedPath,
  type Lang,
} from '../../i18n/utils'
import Layout from '../../layouts/Layout.astro'
import { formatDate } from '../../utils/content'
import Prose from '../Prose.astro'
import TableOfContents from '../TableOfContents.astro'

interface Props {
  post: CollectionEntry<'posts'>
  availableLangs: Lang[]
  lang: Lang
}

const { post, availableLangs, lang } = Astro.props
const { Content, headings } = await render(post)
const translatePath = useTranslatedPath(lang)
const copy = getPageCopy('post', lang)
const locale = getLocaleFromLang(lang)
const author =
  lang === 'zh'
    ? {
        '@type': 'Person',
        name: 'Kevin Deng',
        alternateName: '智子',
        url: 'https://sxzz.dev',
      }
    : { '@type': 'Person', name: 'Kevin Deng', url: 'https://sxzz.dev' }
const schema = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: post.data.title,
  description: post.data.description,
  datePublished: post.data.date.toISOString(),
  url: Astro.url.href,
  inLanguage: locale,
  author,
}
---

<Layout
  title={`${post.data.title} - ${copy.titleSuffix}`}
  description={post.data.description}
  availableLangs={availableLangs}
  ogType="article"
  publishedDate={post.data.date}
>
  <script
    slot="head"
    type="application/ld+json"
    set:html={JSON.stringify(schema)}
  />
  <main class="flex-1 grid grid-cols-[1fr_minmax(0,36rem)_1fr] px-6 py-16 md:px-12">
    <div></div>
    <article class="w-full min-w-0">
      <header class="fade-in-up mb-10" style="animation-delay: 80ms">
        <a
          href={translatePath('/posts')}
          class="mb-6 inline-flex items-center gap-1 text-sm text-stone-500 transition-colors duration-200 dark:text-stone-400 hover:text-stone-700 dark:hover:text-stone-300"
        >
          &larr; {copy.backLabel}
        </a>
        <h1
          class="text-3xl text-stone-900 font-700 leading-tight tracking-tight font-serif md:text-4xl dark:text-white"
        >
          {post.data.title}
        </h1>
        <time class="mt-2 block text-sm text-stone-500 dark:text-stone-400">
          {formatDate(post.data.date, lang)}
        </time>
      </header>

      <Prose
        class="fade-in-up"
        style="animation-delay: 160ms"
        cjkFallback={lang === 'zh'}
      >
        <Content />
      </Prose>
    </article>
    <div class="hidden pl-12 xl:block fade-in-up" style="animation-delay: 240ms">
      <TableOfContents headings={headings} lang={lang} />
    </div>
  </main>
  <script>
    import '../../scripts/toc'
  </script>
</Layout>
